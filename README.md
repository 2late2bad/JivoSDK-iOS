# **Jivo Mobile SDK для iOS (beta)**

## **Актуальная версия: 1.5.1**

### Список изменений:
- исправлены баги с отображением ячеек в ленте чата, когда бабблы сообщений наползали друг на друга, либо наоборот имели слишком большие отступы;
- исправлен баг с пагинацией, когда при загрузке и отображении серии предыдущих сообщений часть из них помещалась в самый низ ленты чата;
- исправлен баг с отображением клавиатуры при анимированном появлении view экрана чата, когда клавиатура закрывала собой часть панели ввода. Это происходило, например, при использовании семейства методов **place**, объявленных в **IJivoSDKChattingUI**, для отображения экрана чата.

Список изменений предыдущих версий вы можете найти [здесь](https://docs.google.com/document/d/1NEFVaK97jw559PfP1QsS6HGSE91y4yI3chp84zInIT0/edit?usp=sharing).

**Jivo SDK** – это фреймворк для интеграции бизнес-чата Jivo в ваше приложение.

Размер бинарного файла **Jivo SDK** для архитектур девайсов составляет приблизительно **4 МБ**. Размер **dSYMs** для фреймворка составляет приблизительно **8,9 МБ**.

Для работы с фреймворком вам доступны API на следующих языках (платформах):
- Swift;
- Objective-C;
- JavaScript (React Native).

На данный момент Jivo SDK **НЕ** поддерживает **bitcode**.

Сейчас Jivo SDK поддерживает следующие языки:
- русский;
- английский;
- испанский;
- португальский;
- турецкий.

### React Native

Часть разделов этого документа имеют адаптированные версии с инструкциями по интеграции Jivo SDK в React Native проекты. Адаптированные разделы вы можете найти здесь. Остальные разделы этого документа по-прежнему актуальны для React Native.

## Установка

### Для нативных проектов

### CocoaPods

#### Требования

Для установки Jivo SDK в свой проект Xcode вам потребуется: 
- Xcode 12.0 или новее; 
- CocoaPods 1.10.0 или новее (проверить версию CocoaPods можно, выполнив следующую команду в терминале: `$ pod --version`); 
- настроить deployment target в проекте на iOS версии 11.0 или более новую.

#### Шаги установки
1. Укажите в Podfile своего проекта следующие источники для pod'ов: 
```ruby
source 'https://github.com/CocoaPods/Specs.git' 
source 'https://github.com/JivoChat/JMSpecsRepo.git'
```

2. Укажите JivoSDK как зависимость в вашем Podfile:
```ruby
use_frameworks!

target :YourTargetName do 
  pod 'JivoSDK', ‘~> 1.5’ 
end
```

3. Добавьте post-install блок в свой Podfile:
```ruby
post_install do |installer| 
  installer.pods_project.targets.each do |target| 
    target.build_configurations.each do |config| 
      config.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'YES' 
    end 
  end 
end
```

> Блок post-install добавляет поддержку module stability для всех pod'ов в вашем проекте. Это необходимо для того, чтобы один и тот же пакет JivoSDK.xcframework можно было использовать, не пересобирая на всех версиях Xcode выше 12.0 (версия, на которой JivoSDK.xcframework был собран). Корректная работа JivoSDK возможна только в том случае, если все его зависимости также будут поддерживать module stability.

4. Выполните в терминале команду: 
```bash
$ pod install
```

### Для React Native
Инструкцию по установке Jivo SDK в React Native проект вы можете найти в разделе “Установка” здесь. Остальные разделы этого документа при отсутствии ссылки на адаптированную версию актуальны и для React Native проектов.

## Настройка

Для полноценной работы JivoSDK необходимо сделать ещё несколько вещей.

### 1. Разрешения приложения 

JivoSDK использует камеру устройства. Также ему необходим доступ к фотогалерее. Для получения необходимых разрешений добавьте соответствующие ключи в файл Info.plist вашего проекта:
- для получения доступа к камере устройства добавьте ключ `NSCameraUsageDescription` и значение для него; 
- для получения доступа к фото галерее на устройстве добавьте ключ `NSPhotoLibraryUsageDescription` и значение для него.

### 2. Настройка PUSH-уведомлений

> PUSH-уведомления не работают в sandbox окружении, иными словами, вы не сможете проверить работу уведомлений в debug-сборке вашего приложения. Протестировать работу PUSH-уведомлений возможно только в release-сборке, загруженной в AppStore (TestFlight).

1. В настройках проекта во вкладке Signing & Capabilities добавьте новую возможность (capability) – Background Modes, и в появившемся разделе отметьте пункт Remote notifications; 
2. в той же вкладке добавьте новую возможность (capability) – Push Notifications; 
3. наши PUSH-уведомления используют локализацию на стороне клиента ([подробнее в разделе "Localize Your Alert Messages"](https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/generating_a_remote_notification)). В теле уведомления для заголовка и сообщения PUSHа указаны ключи локализации. Добавьте в файлы локализации *.strings вашего проекта строки для следующих ключей:
- JV_MESSAGE_TITLE – ключ заголовка PUSHа; 
- JV_MESSAGE – ключ сообщения PUSHа.

Помимо ключей в теле PUSH-уведомления мы передаём ещё и аргументы, которые вы также можете использовать при локализации текста PUSHа: 
- первый аргумент содержит имя пользователя, который отправил сообщение;
- второй аргумент содержит текст сообщения.

Вот пример того, как может выглядеть локализация текста PUSH-уведомления в файле локализации *.strings для русского языка: 
```
"JV_MESSAGE_TITLE" = "Поддержка"; 
"JV_MESSAGE" = "%1$@: %2$@"; // '%1$@' и '%2$@' - это плейсхолдеры для аргументов PUSH-уведомления
```

4. добавьте ключ для Apple Push Notifications service (APNs) в разделе Keys на странице своего аккаунта в developer.apple.com (или используйте уже существующий ключ APNs);
5. передайте нам созданный ключ, а также: 
- key_id; 
- bundle_id; 
- team_id. 
> Для передачи ключа APNs вместе с дополнительными данными свяжитесь с нами.

### 3. Настройка канала в Jivo 

Для работы JivoSDK вам необходим канал специального типа – mobile SDK. Пока что его нельзя создать в личном кабинете Jivo. Для создания канала с типом mobile SDK или смены типа уже существующего канала на данный тип `свяжитесь с нами`.

## Использование

### В нативных проектах 

Jivo SDK API поделено на три, условно говоря, пространства имён: 
- session – отвечает за всё, что связано с сеансом общения клиента и оператора, например, подключение, данные клиента, настройка и обработка PUSH-уведомлений; 
- chattingUI – отвечает за всё, что связано с визуальным представлением чата на экране; 
- debugging – отвечает за отладку SDK. 

Каждое из них содержит методы и свойства, объединённые общей областью ответственности, и каждому из них соответствует статический объект, доступ к которому можно получить из JivoSDK, например:

```
JivoSDK.[пространство имён].[метод или свойство]
```

#### Пример кода для отображения UI чата SDK на экране:

```swift
final class AppDelegate: UIResponder, UIApplicationDelegate {
    func application(_ application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {
        JivoSDK.session.setPushToken(data: deviceToken)
    }
}

final class ProfileViewController {

    // ...

    private func pushSupportScreen() {
        guard let container = self.navigationController else { return }
        JivoSDK.session.startUp(channelID: "abcdef", userToken: "user@example.com")
        JivoSDK.chattingUI.push(into: container)
    }

    private func presentSupportScreen() {
        JivoSDK.session.startUp(channelID: "abcdef", userToken: "user@example.com")
        JivoSDK.chattingUI.present(over: self)
    }
}
```

### В React Native

Инструкцию по использованию Jivo SDK в React Native проекте вы можете найти в разделе “Использование” здесь. Остальные разделы этого документа при отсутствии ссылки на адаптированную версию актуальны и для React Native проектов.

## Описание методов и свойств

### Для нативных проектов
### **session**
#### `delegate`
Объявлен как: 

```swift
var delegate: JivoSDKSessionDelegate?
```

Устанавливает делегат для обработки событий, связанных с соединением и сессией клиента.
> На данный момент протокол JivoSDKSessionDelegate не содержит ни одного объявления внутри себя. Расскажите нам, какие свойства или методы обратного вызова вы бы хотели увидеть в нём.

#### `startUp(channelID:userToken:)`
Объявлен как:

```swift
func startUp(channelID: String, userToken: String)
```

Устанавливает соединение между SDK и нашими серверами, создавая новую сессию, либо возобновляя уже существующую. 
> Не вызывайте этот метод при отображённом на экране UI чата Jivo SDK. 
> Всегда вызывайте метод `shutDown()` перед тем, как повторно вызвать метод `startUp(channelID:userToken:)` с параметром `userToken`, отличным от того, что использовался в сессии ранее.

**Параметры:**
- `channelID: String` – идентификатор вашего канала в Jivo (то же самое, что и `widget ID`); 
- `userToken: String` – уникальный ключ для клиента, зашедшего в чат, по которому определяется, требуется ли создать новую сессию с новым диалогом, либо восстановить уже существующую и загрузить историю начатого диалога. userToken сохраняется в Keychain, поэтому восстановление сессии возможно и после удаления-переустановки приложения, и при смене девайса (при условии включенной синхронизации данных Keychain в iCloud).

#### `updateCustomData(_:)`
Объявлен как:

```swift
func updateCustomData(_ data: JivoSDKSessionCustomData?)
```

Задаёт дополнительную информацию о клиенте, которая отображается оператору.

> На данный момент реализация метода такова, что для обновления дополнительной информации о клиенте на стороне оператора вам необходимо вызвать метод `startUp(channelID:userToken:)` после изменения custom data.

**Параметры:**
- `data: JivoSDKSessionCustomData?` – дополнительная информация о клиенте, содержащаяся в свойствах объекта JivoSDKSessionCustomData (задаются через инициализатор, достаточно указать только те параметры, которые вы собираетесь задать): 
  - `name: String?` – имя клиента; 
  - `email: String?` – E-mail клиента; 
  - `phone: String?` – телефон клиента; 
  - `brief: String?` – дополнительная информация о клиенте в произвольной форме. 

#### `setPushToken(data:)`
Объявлен как:

```swift
func setPushToken(data: Data?)
```

Передаёт в SDK PUSH-токен устройства в видe Data, ассоциируя его с клиентом сессии.

Когда PUSH-токен устройства попадает в SDK, он ассоциируется с конкретным клиентом и отправляется на сервер Jivo. После того, как сервер получает токен, у него появляется возможность отправлять PUSH-уведомления на устройство.

Если PUSH-токен устройства был задан до вызова метода 
`startUp(channelID:userToken:)`, то он сохраняется в SDK и будет отправлен на сервер Jivo после установления соединения. В случае, если PUSH-токен был установлен после вызова метода `startUp(channelID:userToken:)`, токен будет отправлен немедленно.

Для того, чтобы отписать устройство от PUSH уведомлений, вызовите метод `shutDown()`. 

#### `setPushToken(hex:)`
Объявлен как: 

```swift
func setPushToken(hex: String?)
```

Передаёт в SDK PUSH-токен устройства в виде String, ассоциируя его с клиентом сессии.

Когда PUSH-токен устройства попадает в SDK, он ассоциируется с конкретным клиентом и отправляется на сервер Jivo. После того, как сервер получает токен, у него появляется возможность отправлять PUSH-уведомления на устройство. 

Если PUSH-токен устройства был задан до вызова метода 
`startUp(channelID:userToken:)`, то он сохраняется в SDK и будет отправлен на сервер Jivo после установления соединения. В случае, если PUSH-токен был установлен после вызова метода `startUp(channelID:userToken:)`, токен будет отправлен немедленно. 

Для того, чтобы отписать устройство от PUSH уведомлений, вызовите метод `shutDown()`. 

#### `detectPushPayload(_:deliveryDate:)`
Объявлен как:

```swift
func detectPushPayload(_ payload: [AnyHashable : Any]) -> Bool
```

Обрабатывает данные PUSH-уведомления и возвращает true, если уведомление было отправлено со стороны Jivo, либо false, если уведомление было отправлено со стороны другой системы.

**Параметры:**
- `payload: [AnyHashable : Any]` – словарь с данными из тела PUSH-уведомления.

#### `handlePushPayload(_:deliveryDate:)`
Объявлен как:

```swift
func handlePushPayload(_ payload: [AnyHashable : Any], deliveryDate: Date?) -> Bool
```

Обрабатывает данные PUSH-уведомления и возвращает true, если уведомление было отправлено со стороны Jivo, либо false, если уведомление было отправлено со стороны другой системы.

Если PUSH был отправлен со стороны Jivo, то он отображается в виде локального уведомления. Таким образом данный метод можно использовать для отображения in-app уведомлений.

**Параметры:**
- `payload: [AnyHashable : Any]` – словарь с данными из тела PUSH-уведомления;
- `deliveryDate: Date?` – дата и время доставки PUSH-уведомления.

#### `shutDown()`
Объявлен как:

```swift
func shutDown()
```

Закрывает текущее соединение, производит очистку локальной базы данных и отправляет запрос на отписку устройства от PUSH-уведомлений для клиента сессии.

> Всегда вызывайте метод `shutDown()` перед тем, как повторно вызвать метод `startUp(channelID:userToken:)` с параметром `userToken`, отличным от того, что использовался в сессии ранее. 

### **chattingUI**

#### `push(into:)`
Объявлен как:

```swift
func push(into navigationController: UINavigationController)
```

Добавляет view controller чата Jivo SDK в стек переданного UINavigationController и отображает чат на экране с настройками UI по-умолчанию.

**Параметры:**
- `into navigationController: UINavigationController` – объект UINavigationController, в стек которого будет добавлен view controller, отвечающий за UI чата. 

#### `push(into:config:)`
Объявлен как:

```swift
func push(into navigationController: UINavigationController, config: JivoSDKChattingConfig)
```

Добавляет view controller чата Jivo SDK в стек переданного `UINavigationController` и отображает чат на экране с указанными настройками UI.

**Параметры:**

- `into navigationController: UINavigationController` – объект `UINavigationController`, в стек которого будет добавлен view controller, отвечающий за UI чата;
- `config: JivoSDKChattingConfig` – конфигурация UI чата со следующими свойствами, задаваемыми через инициализатор (достаточно указать только те параметры, которые вы собираетесь изменить): 
  - `locale: Locale?` – информация о регионе, по которой для UI чата устанавливается соответствующий язык (для локализации интерфейса доступны только те, языки, которые поддерживаются Jivo SDK). Значение по-умолчанию – `Locale.autoupdatingCurrent`;
  - **(Только для Objective-C)** `useDefaultIcon: Bool` – отображать ли иконку оператора по-умолчанию (изображение с логотипом Jivo). Если значение параметра – `true`, то иконка по-умолчанию будет отображена даже в случае указания `customIcon` или отсутствия аватара у оператора; если значение – `false`, то иконка по-умолчанию показана не будет и вместо неё отобразится либо изображение, переданное в параметре `customIcon`, либо аватар оператора при его подключении. При отсутствии `customIcon` и аватара никакое изображение в баре показано не будет, а тексты заголовка и подзаголовка сместятся влево, заполняя собой пустое место. Значение по-умолчанию – `true`;
  - **(Только для Objective-C)** `customIcon: UIImage?` – кастомная иконка оператора до подключения, отображаемая в верхнем баре над окном чата, отображаемая в верхнем баре над окном чата. Если у оператора установлен аватар, то он заменяет собой иконку, переданную в параметре `customIcon`, иначе – `customIcon` продолжает оставаться на экране. Заменяется иконкой по-умолчанию, если значение `useDefaultIcon` равняется `true`. Значение по-умолчанию – `nil`;
  - **(Только для Swift)** `icon: JivoSDKTitleBarIconStyle?` – режим отображения иконки в верхнем баре над окном чата до подключения оператора. Принимает следующие значения типа `JivoSDKTitleBarIconStyle` (перечисление):
    - `default` – стандартная иконка с логотипом Jivo;
    - `hidden` – иконка не будет отображаться. Аватар оператора при наличии отобразится сразу после загрузки, при отсутствии – никакое изображение показано не будет, а тексты заголовка и подзаголовка сместятся влево, заполняя собой пустое место;
    - `custom(UIImage)` – кастомное изображение, передаваемое в associated value кейса перечисления..; 
  - `titlePlaceholder: String?` – текст заголовка , отображаемого в верхнем баре над окном чата, до того момента, как SDK не получит имя оператора (оно заменит собой текст `titlePlaceholder`)). Значение по-умолчанию – локализованная строка “Чат с поддержкой”; 
  - `titleColor: UIColor?` – цвет заголовка, отображаемого в верхнем баре над окном чата. Значение по-умолчанию – объект `UIColor`, содержащий чёрный/белый цвет (в зависимости от применённой темы); 
  - `subtitleCaption: String?` – текст подзаголовка, отображаемого в верхнем баре над окном чата. Значение по-умолчанию – локализованная строка “На связи 24/7!”; 
  - `subtitleColor: UIColor?` – цвет подзаголовка, отображаемого в верхнем баре над окном чата. Значение по-умолчанию – объект `UIColor`, содержащий светло-серый цвет; 
  - `inputPlaceholder: String?` – плейсхолдер текстового поля ввода внизу окна чата. Значение по-умолчанию – локализованная строка “Введите ваше сообщение”;
  - `activeMessage: String?` – текст активного приглашения. Активное приглашение – это сообщение, которое автоматически отображается для новых клиентов в ленте чата слева. Если при инициализации для свойства передать `nil`, то активное приглашение показано не будет. Сообщение с активным приглашением отобразится только после того, как будет установлено соединение с сервером.


#### `place(within:)`
Объявлен как:

```swift
func place(within navigationController: UINavigationController)
```

Удаляет весь стек view controller'ов в переданном объекте `UINavigationController` и добавляет в стек view controller, отвечающий за UI чата, с настройками отображения по умолчанию. 

**Параметры:**
- `within navigationController: UINavigationController` – объект `UINavigationController`, стек которого будет заменён на view controller, отвечающий за UI чата.

#### `place(within:config:)`
Объявлен как:

```swift
func place(within navigationController: UINavigationController, config: JivoSDKChattingConfig) 
```

Удаляет весь стек view controller'ов в переданном объекте `UINavigationController` и добавляет в стек view controller, отвечающий за UI чата, с заданными настройками отображения.

**Параметры:**
- `within navigationController: UINavigationController` – объект `UINavigationController`, стек которого будет заменён на view controller, отвечающий за UI чата; 
- `config: JivoSDKChattingConfig` – конфигурация UI чата (подробнее – в описании метода `push(into:config:)`)

#### `present(over:)`
Объявлен как:

```swift
func present(over viewController: UIViewController)
```

Отображает модально UI чата на экране с визуальными настройками по-умолчанию, вызывая метод `present(_:animated:)` для переданного view controller. Всегда выполняется анимировано.

**Параметры:**
- `over viewController: UIViewController` – view controller, поверх которого будет модально отображаться UI чата.

#### `present(over:config:)`
Объявлен как:

```swift
func present(over viewController: UIViewController, config: JivoSDKChattingConfig)
```

Отображает модально UI чата на экране с заданными визуальными настройками, вызывая метод `present(_:animated:)` для переданного view controller. Всегда выполняется анимировано.

**Параметры:**
- `over viewController: UIViewController` – view controller, поверх которого будет модально отображаться UI чата; 
- `config: JivoSDKChattingConfig` – конфигурация UI чата (подробнее – в описании метода `push(into:config:)`). 

### **debugging**

#### `level`
Объявлено как:

```swift
var level: JivoSDKDebuggingLevel { get set }
```

С помощью этого свойства вы можете задать степень того, насколько подробно будет производиться логирование в SDK.

Перечисление `JivoSDKDebuggingLevel` содержит следующие кейсы:
- `full` – режим полного логирования;
- `silent` – логирование не ведётся.

#### `archiveLogs(completion:)`
Объявлен как:

```swift
func archiveLogs(completion: @escaping (URL?, JivoSDKArchivingStatus) -> Void)
```

Выполняет архивацию сохранённых записей логов и возвращает в completion-блоке ссылку на созданный архив и статус.

**Параметры:**
- `completion: @escaping (URL?, JivoSDKArchivingStatus) -> Void` – замыкание, которое будет вызвано по завершению операции. В блок будут переданы URL (если удалось создать архив) и статус результата операции.

Перечисление `JivoSDKArchivingStatus` содержит следующие кейсы:
- `success` – сохранённые записи логов были успешно заархивированы, параметр замыкания типа URL? содержит ссылку на созданный архив;
- `failedAccessing` – не удалось получить доступ к файлу архива в папке Caches, параметр замыкания типа URL? равен nil;
- `failedPreparing` – не удалось подготовить содержимое архива, возможна ошибка кодировки, параметр замыкания типа URL? равен nil.

### Для React Native

Описание методов Jivo SDK в React Native проекте вы можете найти в разделе “Описание методов” здесь. Остальные разделы этого документа при отсутствии ссылки на адаптированную версию актуальны и для React Native проектов.

